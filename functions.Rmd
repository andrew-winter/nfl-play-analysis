---
title: "NFL play-by-play data functional programming"
author: "Andrew Winter"
date: "2025-10-30"
output:
  html_document:
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = "hide")
```

## Simple functions, complex NFL play-by-play data

I have explored [nflverse](https://github.com/nflverse) pbp data [a few times](https://github.com/andrew-winter/nfl-play-analysis), so today I'll try to standardize different parts of the analysis with functions, namely

1. Load R and Python packages
2. Confirm metadata definitions are accurate
3. Select variables for analysis
4. Read data season by season, possibly concatenate
5. Visualize

```{r packages, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(purrr)
library(stringr)
library(reticulate)
```

```{python modules, message=FALSE}
import json
import os
import pandas as pd
import re
import requests
from bs4 import BeautifulSoup
from scripts.read_nflverse_dictionary import read_nflverse_dictionary
from scripts.select_variables import select_variables
```

Write out existing Python code before delving into R code

```{python metadata}
year_min = 2016
year_max = 2025

# Confirm working data dictionary
try:
    data_dictionary = read_nflverse_dictionary()
    pbp_dtypes = {
      dy["field"]: dy["pdtype"]
      for dy
      in data_dictionary.to_dict("records")}
except:
    data_dictionary = pd.DataFrame()
    pbp_dtypes = {}

# Reduce hundreds of pbp columns to tens
pbp_columns = select_variables()
```

```{python iterate read_csv}
pbp_df = pd.DataFrame()
for yr in range(year_min, year_max + 1):
    file = os.path.join(os.getcwd(), "data", "pbp", f"play_by_play_{yr}.csv")
    # Collected data dictionary in part to map `pandas` dtypes
    df = pd.read_csv(file, dtype=pbp_dtypes, usecols=pbp_columns)
    pbp_df = pd.concat([pbp_df, df], ignore_index=True)
```

```{r data dictionary py_to_r}
# Convert data dictionary from Python to R
data_dictionary <- py$data_dictionary |> 
  reticulate::py_to_r() |> 
  dplyr::as_tibble()
pbp_dtypes <- py$pbp_dtypes
```

```{r pbp py_to_r}
# Convert play-by-play data from Python to R
pbp_df <- py$pbp_df |> 
  reticulate::py_to_r() |> 
  dplyr::as_tibble() |> 
  dplyr::relocate(
    reticulate::py_to_r(py$pbp_columns))
```

```{r groups, include=FALSE}
# "Divide up" the seasons, games, season types, etc
pbp_drives <- pbp_df |> 
  dplyr::group_by(season, season_type, week, game_id, qtr, posteam, drive) |> 
  dplyr::summarize(plays = n()) |> 
  dplyr::arrange(desc(season), desc(season_type), game_id, qtr, drive)

# Kansas City 2025 season example
kc_2025 <- dplyr::filter(pbp_drives, posteam == "KC" & season == 2025)
# New York Jets 2025 Week 8 game example
jets <- dplyr::filter(pbp_df, game_id == "2025_08_NYJ_CIN")

jets |> 
  dplyr::select(drive, play_id, play_type, yrdln, yards_gained, ydstogo, desc) |> 
  dplyr::arrange(drive, play_id)
```

```{r confirm key quarter metadata, include=FALSE}
# For one game ID, identify plays at the start of the game and end of each quarter
id_game_bookmarks <- function(df) {
  if (all(c("desc", "play_id") %in% colnames(jets))) {
    # Bookmarks to determine game start and end of each quarter
    book1 <- dplyr::filter(df, desc == "GAME")
    book2 <- dplyr::filter(df, 
                           stringr::str_detect(desc, 
                                               regex("END QUARTER \\d")))
    book3 <- dplyr::filter(df, desc == "END GAME")
    
    # Benchmarks to determine bookmarks are relative indicators of play_id
    bench1 <- book1$play_id == min(df$play_id)
    print(glue::glue("BENCHMARK 1:\t{bench1}\t\t\t(start of the game)"))
    bench2 <- (book2$play_id > min(df$play_id)) & (book2$play_id < max(df$play_id))
    print(glue::glue("BENCHMARK 2:\t{bench2}\t\t\t(end of quarters 1-3)"))
    bench3 <- book3$play_id == max(df$play_id)
    print(glue::glue("BENCHMARK 3:\t{bench3}\t\t\t(end of the game)"))
    
    benchmarks <- all(c(bench1, bench2, bench3))
    if (benchmarks) {
      dplyr::bind_rows(book1, book2, book3) #|> 
        #dplyr::select(play_id, desc, play_type, drive)
    }
  }
}
jets_bookmarks <- id_game_bookmarks(jets)
```

``` {r summarize drives, include=FALSE}
pbp_drives
```


```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
